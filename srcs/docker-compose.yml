services:

    nginx:
      container_name: nginx
      build: ./nginx
      ports:
        - "8443:443"        # Point d'entr√©e HTTPS public
      depends_on:
        - gateway
        - front
      volumes:
      - ./certs/ca/ca.pem:/etc/nginx/ssl/ca.pem:ro
      networks:
        - transcendence

    gateway:
      container_name: gateway
      build: ./back/gateway
      expose:
        - "8080"            # Port interne uniquement, accessible depuis nginx  
      depends_on:
        auth:
          condition: service_healthy
        user:
          condition: service_healthy
        game:
          condition: service_healthy
        chat:
          condition: service_healthy
      env_file: 
        - .env
      volumes:
      # Monter les certificats
      - ./certs/gateway/gateway.key:/app/certs/service.key:ro
      - ./certs/gateway/gateway.crt:/app/certs/service.crt:ro
      networks: 
        - transcendence 

    front:
      container_name: front
      build: ./front
      expose:
        - "80"
      depends_on:
        - gateway
      networks: 
        - transcendence
      # a retirer seulement pour le dev
      volumes:
        - ./front/dist:/usr/share/nginx/html/dist
        - ./front/public/index.html:/usr/share/nginx/html/index.html
        - ./front/public/assets:/usr/share/nginx/html/assets
        
        # AJOUTEZ CES LIGNES POUR LE DEVELOPPEMENT :
        - ./front/scripts:/usr/share/nginx/html/scripts
        - ./front/styles:/usr/share/nginx/html/styles  # ou /styles selon votre structure
        - ./front/tsconfig.json:/usr/share/nginx/html/tsconfig.json
        - ./front/tailwind.config.js:/usr/share/nginx/html/tailwind.config.js

    auth:
      container_name: auth
      build: ./back/auth
      expose:
        - "3001"
      env_file: 
        - .env
      environment:
        - DATABASE_URL=/app/data/auth.sqlite
      networks: 
        - transcendence
      volumes:
        # - auth_data:/app/data
        - ./back/datadev:/app/data
        - ./certs/auth/auth.key:/app/certs/service.key:ro
        - ./certs/auth/auth.crt:/app/certs/service.crt:ro
      healthcheck:
        test: ["CMD", "sqlite3", "/app/data/auth.sqlite", "SELECT 1;"]
        interval: 2s
        retries: 20

    chat:
      container_name: chat
      build: ./back/chat
      expose:
        - "3002"
      env_file: 
        - .env
      environment:
        - DATABASE_URL=/app/data/chat.sqlite
      networks: 
        - transcendence
      volumes:
        # - chat_data:/app/data
        - ./back/datadev:/app/data
        - ./certs/chat/chat.key:/app/certs/service.key:ro
        - ./certs/chat/chat.crt:/app/certs/service.crt:ro
      healthcheck:
        test: ["CMD", "sqlite3", "/app/data/chat.sqlite", "SELECT 1;"]
        interval: 2s
        retries: 20

    game:
      container_name: game
      build: ./back/game
      expose:
        - "3003"
      env_file: 
        - .env
      environment:
        - DATABASE_URL=/app/data/game.sqlite
      networks:
        - transcendence
      volumes:
        # - game_data:/app/data
        - ./back/datadev:/app/data
        - ./certs/game/game.key:/app/certs/service.key:ro
        - ./certs/game/game.crt:/app/certs/service.crt:ro
      healthcheck:
        test: ["CMD", "sqlite3", "/app/data/game.sqlite", "SELECT 1;"]
        interval: 2s
        retries: 20

    user:
      container_name: user
      build: ./back/user
      expose:
        - "3004"
      env_file: 
        - .env
      environment:
        - DATABASE_URL=/app/data/user.sqlite
      networks: 
        - transcendence
      volumes:
        # - user_data:/app/data
        # - user_avatars:/app/user/avatars
        - ./back/datadev:/app/data
        - ./certs/user/user.key:/app/certs/service.key:ro
        - ./certs/userhttp/user.crt:/app/certs/service.crt:ro
      healthcheck:
        test: ["CMD", "sqlite3", "/app/data/user.sqlite", "SELECT 1;"]
        interval: 2s
        retries: 20
    
networks:
  transcendence:
    name: transcendence
    driver: bridge

volumes:
  # user_avatars:
  # auth_data:
  # chat_data:
  # user_data:
  # game_data:

  datadev: